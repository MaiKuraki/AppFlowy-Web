name: Integration Tests

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  workflow_dispatch:

env:
  CLOUD_VERSION: latest-amd64

jobs:
  integration-test:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          
      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 10.9.0
          run_install: false

      - name: Get pnpm store directory
        shell: bash
        run: |
          echo "STORE_PATH=$(pnpm store path --silent)" >> $GITHUB_ENV

      - name: Setup pnpm cache
        uses: actions/cache@v4
        with:
          path: ${{ env.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Clean and Run Docker-Compose
        run: |
          echo "Stopping existing compose services..."
          docker compose down -v --remove-orphans || true
          
          echo "Removing project-specific resources..."
          docker compose rm -f -s -v || true
          
          echo "Cleaning up unused Docker resources..."
          docker container prune -f || true
          docker image prune -f || true
          docker network prune -f || true
          docker volume prune -f || true
          
          echo "Docker cleanup completed successfully"

      - name: Checkout AppFlowy-Cloud-Premium code
        uses: actions/checkout@v4
        with:
          repository: AppFlowy-IO/AppFlowy-Cloud-Premium
          path: AppFlowy-Cloud-Premium
          token: ${{ secrets.ADMIN_GITHUB_TOKEN }}
          ref: 'main'

      - name: Run Server
        working-directory: AppFlowy-Cloud-Premium
        run: |
          cp deploy.env .env
          sed -i 's|GOTRUE_MAILER_AUTOCONFIRM=.*|GOTRUE_MAILER_AUTOCONFIRM=true|' .env
          sed -i 's|API_EXTERNAL_URL=.*|API_EXTERNAL_URL=http://localhost|' .env
          sed -i 's|APPFLOWY_SPAM_DETECT_ENABLED=.*|APPFLOWY_SPAM_DETECT_ENABLED=false|' .env
          sed -i 's|AI_OPENAI_API_KEY=.*|AI_OPENAI_API_KEY=${{ secrets.CI_OPENAI_API_KEY }}|' .env

          cat .env

          export APPFLOWY_ENVIRONMENT=local
          export APPFLOWY_CLOUD_VERSION=${{ env.CLOUD_VERSION }}
          export APPFLOWY_WORKER_VERSION=${{ env.CLOUD_VERSION }}
          export APPFLOWY_ADMIN_FRONTEND_VERSION=${{ env.CLOUD_VERSION }}
          export APPFLOWY_AI_VERSION=${{ env.CLOUD_VERSION }}

          docker login -u appflowyinc -p ${{ secrets.DOCKER_TOKEN }}
          docker compose pull
          docker compose up -d
          echo "Waiting for the container to be ready..."
          sleep 30
          docker ps -a

      - name: Check backend health
        run: |
          max_attempts=30
          attempt=0
          while [ $attempt -lt $max_attempts ]; do
            if curl --fail http://localhost/health; then
              echo "Backend is healthy"
              break
            fi
            echo "Waiting for backend... (attempt $((attempt+1))/$max_attempts)"
            sleep 5
            attempt=$((attempt+1))
          done
          if [ $attempt -eq $max_attempts ]; then
            echo "Backend failed to become healthy"
            docker compose logs
            exit 1
          fi

      - name: Build application
        run: pnpm run build

      - name: Start development server
        run: |
          pnpm run dev &
          sleep 10
          curl --fail http://localhost:3000 || exit 1

      - name: Run integration tests
        run: |
          export AF_BASE_URL=http://localhost
          export CYPRESS_BASE_URL=http://localhost:3000
          export GOTRUE_ADMIN_EMAIL=admin@example.com
          export GOTRUE_ADMIN_PASSWORD=password
          pnpm run test:integration
        env:
          AF_BASE_URL: http://localhost
          CYPRESS_BASE_URL: http://localhost:3000
          GOTRUE_ADMIN_EMAIL: admin@example.com
          GOTRUE_ADMIN_PASSWORD: password
          CI: true
          
      - name: Run publish feature integration tests
        run: |
          export AF_BASE_URL=http://localhost
          export CYPRESS_BASE_URL=http://localhost:3000
          export GOTRUE_ADMIN_EMAIL=admin@example.com
          export GOTRUE_ADMIN_PASSWORD=password
          pnpm run test:integration:publish
        env:
          AF_BASE_URL: http://localhost
          CYPRESS_BASE_URL: http://localhost:3000
          GOTRUE_ADMIN_EMAIL: admin@example.com
          GOTRUE_ADMIN_PASSWORD: password
          CI: true

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: cypress-results
          path: |
            cypress/videos
            cypress/screenshots
            
      - name: Upload coverage reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: coverage-reports
          path: |
            coverage/
            .nyc_output/

      - name: Show docker logs on failure
        if: failure()
        working-directory: AppFlowy-Cloud-Premium
        run: |
          docker compose logs

      - name: Cleanup
        if: always()
        working-directory: AppFlowy-Cloud-Premium
        run: |
          docker compose down -v

  publish-integration-test:
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request' || github.ref == 'refs/heads/main'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          
      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 10.9.0

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Checkout AppFlowy-Cloud-Premium code
        uses: actions/checkout@v4
        with:
          repository: AppFlowy-IO/AppFlowy-Cloud-Premium
          path: AppFlowy-Cloud-Premium
          token: ${{ secrets.ADMIN_GITHUB_TOKEN }}
          ref: 'main'

      - name: Run Server for Publish Testing
        working-directory: AppFlowy-Cloud-Premium
        run: |
          cp deploy.env .env
          sed -i 's|GOTRUE_MAILER_AUTOCONFIRM=.*|GOTRUE_MAILER_AUTOCONFIRM=true|' .env
          sed -i 's|API_EXTERNAL_URL=.*|API_EXTERNAL_URL=http://localhost|' .env
          sed -i 's|APPFLOWY_SPAM_DETECT_ENABLED=.*|APPFLOWY_SPAM_DETECT_ENABLED=false|' .env
          sed -i 's|AI_OPENAI_API_KEY=.*|AI_OPENAI_API_KEY=${{ secrets.CI_OPENAI_API_KEY }}|' .env

          export APPFLOWY_ENVIRONMENT=local
          export APPFLOWY_CLOUD_VERSION=${{ env.CLOUD_VERSION }}
          export APPFLOWY_WORKER_VERSION=${{ env.CLOUD_VERSION }}
          export APPFLOWY_ADMIN_FRONTEND_VERSION=${{ env.CLOUD_VERSION }}
          export APPFLOWY_AI_VERSION=${{ env.CLOUD_VERSION }}

          docker login -u appflowyinc -p ${{ secrets.DOCKER_TOKEN }}
          docker compose pull
          docker compose up -d
          sleep 30

      - name: Build and start application
        run: |
          pnpm run build
          pnpm run dev &
          sleep 10

      - name: Test publish workflow
        run: |
          export AF_BASE_URL=http://localhost
          export CYPRESS_BASE_URL=http://localhost:3000
          pnpm run test:integration:publish
        env:
          AF_BASE_URL: http://localhost
          CYPRESS_BASE_URL: http://localhost:3000
          
      - name: Cleanup
        if: always()
        working-directory: AppFlowy-Cloud-Premium
        run: |
          docker compose down -v