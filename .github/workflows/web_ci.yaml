name: Web-CI
on:
  pull_request:
    branches:
      - "main"
      - "develop"
      - "release/*"
env:
  NODE_VERSION: "18.16.0"
  PNPM_VERSION: "10.9.0"
concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true
jobs:
  web-build:
    if: github.event.pull_request.draft != true
    strategy:
      fail-fast: false
      matrix:
        platform: [ ubuntu-latest ]

    runs-on: ${{ matrix.platform }}

    steps:
      - uses: actions/checkout@v4
      - name: Maximize build space (ubuntu only)
        if: matrix.platform == 'ubuntu-latest'
        run: |
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /opt/ghc
          sudo rm -rf "/usr/local/share/boost"
          sudo rm -rf "$AGENT_TOOLSDIRECTORY"
          sudo docker image prune --all --force
          sudo rm -rf /opt/hostedtoolcache/codeQL
          sudo rm -rf ${GITHUB_WORKSPACE}/.git
          sudo rm -rf $ANDROID_HOME/ndk
      - name: setup node
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
      - name: setup pnpm
        uses: pnpm/action-setup@v3
        with:
          version: ${{ env.PNPM_VERSION }}
     
      - name: install frontend dependencies
        run: |
          pnpm install
      - name: Run lint check
        run: |
          pnpm run lint

      - name: build and analyze
        run: |
          pnpm run analyze >> analyze-size.txt
      - name: Upload analyze-size.txt
        uses: actions/upload-artifact@v4
        with:
          name: analyze-size.txt
          path: analyze-size.txt
          retention-days: 30
      - name: Upload stats.html
        uses: actions/upload-artifact@v4
        with:
          name: stats.html
          path: dist/stats.html
          retention-days: 30

  docker-runtime-test:
    if: github.event.pull_request.draft != true
    runs-on: ubuntu-24.04
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Build Docker image (runtime env injection test)
        run: |
          docker build -t appflowy-web-test:ci -f docker/Dockerfile .

      - name: Run container with injected env vars
        run: |
          docker run -d --rm --name appflowy-web-test -p 8080:80 \
            -e AF_BASE_URL=https://ci-backend.example.com \
            -e AF_GOTRUE_URL=https://ci-backend.example.com/gotrue \
            -e AF_WS_V2_URL=wss://ci-backend.example.com/ws/v2 \
            appflowy-web-test:ci

      - name: Wait for server to be ready
        run: |
          for i in $(seq 1 30); do
            if curl -fsS http://localhost:8080/ >/dev/null 2>&1; then
              echo "Server is up"; break; fi; sleep 1; done
          curl -fsS http://localhost:8080/ >/dev/null

      - name: Verify injected runtime config in index.html
        run: |
          set -e
          HTML=$(curl -fsS http://localhost:8080/index.html)
          echo "$HTML" | grep -q "window.__APP_CONFIG__" || (echo "Missing __APP_CONFIG__" && exit 1)
          echo "$HTML" | grep -q "AF_BASE_URL: 'https://ci-backend.example.com'" || (echo "AF_BASE_URL not injected" && exit 1)
          echo "$HTML" | grep -q "AF_GOTRUE_URL: 'https://ci-backend.example.com/gotrue'" || (echo "AF_GOTRUE_URL not injected" && exit 1)
          echo "$HTML" | grep -q "AF_WS_V2_URL: 'wss://ci-backend.example.com/ws/v2'" || (echo "AF_WS_V2_URL not injected" && exit 1)

      - name: Show container logs on failure
        if: failure()
        run: |
          docker logs appflowy-web-test || true

      - name: Cleanup container
        if: always()
        run: |
          docker rm -f appflowy-web-test || true
